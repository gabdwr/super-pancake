name: DexScreener Hourly Scraper

# Run every hour to discover new tokens
on:
  schedule:
    # Runs at the start of every hour (e.g., 1:00, 2:00, 3:00...)
    - cron: '0 * * * *'

  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  scrape-tokens:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔧 Create .env file from secrets
        run: |
          cat > .env << EOF
          SUPABASE_HOST=${{ secrets.SUPABASE_HOST }}
          SUPABASE_PORT=${{ secrets.SUPABASE_PORT }}
          SUPABASE_USERNAME=${{ secrets.SUPABASE_USERNAME }}
          SUPABASE_PASSWORD=${{ secrets.SUPABASE_PASSWORD }}
          SUPABASE_DBNAME=${{ secrets.SUPABASE_DBNAME }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          EOF

      - name: ⛏️ Run DexScreener scraper
        id: scraper
        run: |
          python run_dexscraper.py
        continue-on-error: true

      - name: 📊 Check results
        run: |
          if [ "${{ steps.scraper.outcome }}" == "failure" ]; then
            echo "❌ Scraper failed"
            exit 1
          else
            echo "✅ Scraper completed successfully"
          fi

      - name: 🧹 Cleanup .env file
        if: always()
        run: |
          rm -f .env

# Workflow summary:
# - Runs every hour on the hour (UTC timezone)
# - Discovers new tokens from DexScreener
# - Stores unique tokens in Supabase (duplicates automatically skipped)
# - Sends Telegram notification on completion
# - Can be manually triggered from GitHub Actions tab
#
# Note: GitHub Actions runs can be delayed by 1-5 minutes during high load
